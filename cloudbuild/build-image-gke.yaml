steps:
  # Build/install the mvn project
- name: 'gcr.io/cloud-builders/mvn'
  args: ['install']
  # Build the container image
- name: 'gcr.io/cloud-builders/docker'
  args: ['build', '--tag=gcr.io/$PROJECT_ID/github.com/zippoobbiz/gcp-streaming-tweets-pubsub-java:$SHORT_SHA', '.']
  # Push the container image to Container Registry
- name: 'gcr.io/cloud-builders/docker'
  args: ['push', 'gcr.io/$PROJECT_ID/github.com/zippoobbiz/gcp-streaming-tweets-pubsub-java:$SHORT_SHA']
- name: 'gcr.io/cloud-builders/kubectl'
  args: ['delete', 'secret', 'twitter-stream-secret']
  env:
  - 'CLOUDSDK_COMPUTE_ZONE=australia-southeast1-a'
  - 'CLOUDSDK_CONTAINER_CLUSTER=standard-cluster-1'
- name: 'gcr.io/cloud-builders/kubectl'
  entrypoint: 'bash'
  args: 
  - '-c' 
  - 'kubectl create secret generic twitter-stream-secret --from-literal=TWKEYWORDS=big,query,Bigquery,BigQuery --from-literal=TWBATCHSIZE=5 --from-literal=TWLANGUAGE=en --from-literal=TWPROJECTID=phil-xu-sandpit --from-literal=PUBSUB_TOPIC=twittstopic --from-literal=ACCESSTOKEN=$$ACCESSTOKEN --from-literal=ACCESSTOKENSEC=$$ACCESSTOKENSEC --from-literal=CONSUMERKEY=$$CONSUMERKEY --from-literal=CONSUMERSECRET=$$CONSUMERSECRET --from-literal=CREDENTIALS=$$GOOGLECREDENTIAL --from-literal=TWSTREAMMODE=publisher'
  env:
  - 'CLOUDSDK_COMPUTE_ZONE=australia-southeast1-a'
  - 'CLOUDSDK_CONTAINER_CLUSTER=standard-cluster-1'
  secretEnv: ['ACCESSTOKEN', 'ACCESSTOKENSEC', 'CONSUMERKEY', 'CONSUMERSECRET']
  
- name: 'gcr.io/cloud-builders/kubectl'
  args: ['apply', '-f', 'kubernetes/']
  env:
  - 'CLOUDSDK_COMPUTE_ZONE=australia-southeast1-a'
  - 'CLOUDSDK_CONTAINER_CLUSTER=standard-cluster-1'
#step 4
- name: 'gcr.io/cloud-builders/kubectl'
  args: [
   'set', 
   'image', 
   'deployment', 
   'gcp-streaming-tweets-pubsub-java-deployment', 
   'gcp-streaming-tweets-pubsub-java=gcr.io/$PROJECT_ID/github.com/zippoobbiz/gcp-streaming-tweets-pubsub-java:$SHORT_SHA'
  ]
  env:
  - 'CLOUDSDK_COMPUTE_ZONE=australia-southeast1-a'
  - 'CLOUDSDK_CONTAINER_CLUSTER=standard-cluster-1'
images: 
- 'gcr.io/$PROJECT_ID/github.com/zippoobbiz/gcp-streaming-tweets-pubsub-java:$SHORT_SHA'
secrets:
- kmsKeyName: projects/phil-xu-sandpit/locations/global/keyRings/phil-xu-sandpit-key-ring/cryptoKeys/phil-xu-sandpit-key
  secretEnv:
    ACCESSTOKEN: CiQAhOAvUnPLy3KBgQPs0zNq6vLVFIZwo1ko8LyaW4nmzMvHqB8SWwA6MbhPv7e9qOsD8ydsplJgP1hzEjAstj6hvmrD5PEASyFD7JcSTW9+K9oGJtg+a+nJbYmi4DP5h7emlAq8ko2WdQJtWMrss/ZRGLkcwNhtK3PJiDbcRVPCAyc=
    ACCESSTOKENSEC: CiQAhOAvUkMc/igc5O3SKDoqrWkNyqCs9vsHwWzcR9SiYk2CkR8SVgA6MbhP9PHHk54R1cisK+WZbQhFnNEtEUvMqxgyBUR0NyQ6ZluNSDejEFOGFWGNcXtZkODMh5bgNs8qHKlOWwEuJ+0HuTosOxHZSAwNOXV5g/vHvNIk
    CONSUMERKEY: CiQAhOAvUng9cevb2MebDIjsQJc7ZFFeLk15oJ6qcNqHrJ8PriQSPgA6MbhPgL3jDXPV93zw6zg1F1nf3sihG1slDMQAlBoOt62dUHpKQC4F5gorIEH7GCxn/OAdNi9EYHq/oUq5
    CONSUMERSECRET: CiQAhOAvUoirKcVtKCOsCmmCC/Y8x9JTOj53+BvHZyxj6LefWI8SVAA6MbhPLlL6+PoIcr4feTSsssbJIKd5ne4lWvRiXOzh8qmowLENM58fuCnqVetlQ4e3EE6rFwVlr/j2ncnbmaE1c/9Q7qGAL6mxvnry5RoDF3AQcg==
    GOOGLECREDENTIAL: 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